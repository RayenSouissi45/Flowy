{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 style="text-align: center; font-size: 2.5em; margin-top: 80px; margin-bottom: 80px; color: #333;">Backlog</h1>
    
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <select id="projectSelect" class="form-select rounded" style="width: 250px; padding: 8px;" onchange="filterTasksByProject()">
                <option value="" disabled selected>Select a project</option>
                {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <input type="text" id="searchInput" class="form-control rounded" placeholder="Search for tasks..." onkeyup="filterTasks()" style="width: 250px;">
        </div>
    </div>

    <table class="table table-striped table-hover" style="border: 1px solid #dee2e6; border-collapse: collapse;">
        <thead class="thead-dark text-center">
            <tr>
                <th scope="col">Task Title</th>
                <th scope="col">Difficulty</th>
                <th scope="col">Estimated Time</th>
                <th scope="col">Importance</th>
                <th scope="col">User</th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody id="taskTableBody">
            {% for task in tasks %}
            <tr class="text-center" data-project-id="{{ task.project_id }}">
                <td>{{ task.title }}</td>   
                <td>{{ task.difficulty }}</td>
                <td>{{ task.estimated_time }} H</td>
                <td>
                    {% for i in range(1, 6) %}
                        {% if i <= task.importance %}
                            <i class="fas fa-star" style="color: black;"></i>
                        {% else %}
                            <i class="far fa-star" style="color: white;"></i>
                        {% endif %}
                    {% endfor %}
                </td>
                <td>
                    <img src="{{ task.image }}" alt="Task Image" class="rounded-circle" width="30" height="30" style="margin-right: 10px;">
                    <span>{{ task.username }}</span>
                </td>
                <td>
                    <button class="btn btn-danger" data-task-id="{{ task.id }}" onclick="deleteTask(this)">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this task?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </div>
  
</div>

<script>
    function deleteTask(buttonElement) {
    const taskId = buttonElement.getAttribute('data-task-id');

    if (confirm("Are you sure you want to delete this task?")) {
        fetch(`/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Include this if CSRF protection is used
            }
        })
        .then(response => {
            if (response.ok) {
                // Remove the task row from the table
                const row = buttonElement.closest('tr');  // Get the row element
                if (row) {
                    row.remove();
                }
                alert("Task deleted successfully.");
            } else {
                alert("Failed to delete the task.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("An error occurred while trying to delete the task.");
        });
    }
}

    </script>


<script>
function filterTasks() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('taskTableBody');
    const rows = table.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const taskTitle = rows[i].getElementsByTagName('td')[0]; // Assuming task title is the first column
        if (taskTitle) {
            const txtValue = taskTitle.textContent || taskTitle.innerText;
            rows[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
        }
    }
}

function filterTasksByProject() {
    const select = document.getElementById('projectSelect');
    const selectedProjectId = select.value;
    const table = document.getElementById('taskTableBody');
    const rows = table.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const projectId = rows[i].getAttribute('data-project-id'); // Get the data attribute
        rows[i].style.display = selectedProjectId === "" || projectId === selectedProjectId ? "" : "none"; // Show or hide based on selected project
    }

    document.getElementById('searchInput').value = '';
}
</script>

{% endblock %}

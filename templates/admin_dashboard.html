{% extends "base.html" %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; color: #343a40; }
        /* .navbar { background-color: #343a40; padding: 1em; color: white; text-align: center; }
        .navbar a { color: white; text-decoration: none; padding: 0 15px; } */

        .dashboard-container { display: flex; justify-content: center; flex-wrap: wrap; margin: 20px; }
        .chart-container { position: relative; width: 250px; height: 250px; margin: 50px; }
        .chart-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: bold; }
        .project-title { text-align: center; font-size: 18px; margin-top: 10px; font-weight: bold; }
        .view-project-btn { display: block; margin: 10px auto; padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; font-size: 14px; border-radius: 5px; }
        .view-project-btn:hover { background-color: #0056b3; }

        .team-progress { margin: 50px auto; text-align: left; width: 80%; max-width: 800px; }
        .team-member-container { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ccc; }
        .member-name { font-size: 16px; font-weight: bold; width: 150px; }
        .progress-wrapper { flex-grow: 1; margin-left: 20px; }
        .progress-bar-wrapper { position: relative; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #00c0ef; border-radius: 10px 0 0 10px; }
        .issue-bar { height: 100%; background-color: #f56c6c; position: absolute; top: 0; right: 0; border-radius: 0 10px 10px 0; }
        .progress-info { display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px; }

        select { padding: 10px; font-size: 16px; margin-bottom: 20px; }

        .legend { margin-top: 20px; font-size: 14px; text-align: center; }
        .legend div { display: inline-block; margin: 0 10px; }
        .legend-color { width: 20px; height: 20px; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>
    <!-- Navbar Section -->
    <!-- <div class="navbar">
        <a href="#">Home</a>
        <a href="#">Settings</a>
        <a href="#">Reports</a>
    </div> -->

    <!-- Project Display (Dynamic) -->
    <div class="dashboard-container" id="dashboardContainer"></div>

    <!-- Project Select Dropdown -->
    <div class="team-progress">
        <select id="projectSelect" class="project-select">
            <!-- Options will be dynamically generated -->
        </select>
    </div>

    <!-- Team Progress Overview -->
    <div class="team-progress">
        <h2>Team Progress Overview</h2>
        <div id="teamMembers"></div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div><span class="legend-color" style="background-color: #00c0ef;"></span> Progress</div>
        <div><span class="legend-color" style="background-color: #f56c6c;"></span> Issues</div>
    </div>

    <script>
        let projectDataGlobal = []; // Global variable to store project data
    
        // Function to render project cards and charts dynamically
        function renderProjects(projects) {
            const dashboardContainer = document.getElementById('dashboardContainer');
            const projectSelect = document.getElementById('projectSelect');
    
            dashboardContainer.innerHTML = ''; // Clear previous data
            projectSelect.innerHTML = ''; // Clear previous options
    
            projects.forEach((project, index) => {
    // Create project chart container dynamically
    const chartContainer = document.createElement('div');
    chartContainer.classList.add('chart-container');
    chartContainer.id = `project${index + 1}Container`;

    const canvas = document.createElement('canvas');
    canvas.id = `project${index + 1}Chart`;

    const chartText = document.createElement('div');
    chartText.classList.add('chart-text');
    chartText.id = `project${index + 1}Text`;
    chartText.textContent = `${project.progress}%`;

    const projectTitle = document.createElement('div');
    projectTitle.classList.add('project-title');
    projectTitle.textContent = project.name;

    const viewButton = document.createElement('button');
    viewButton.classList.add('view-project-btn');
    viewButton.textContent = 'View Project';

    // Update this part to pass the specific project ID when the button is clicked
    viewButton.addEventListener('click', function() {
        const selectedProjectId = project.id;  // Use the specific project ID
        window.location.href = `/project/${selectedProjectId}`;
    });

    chartContainer.appendChild(canvas);
    chartContainer.appendChild(chartText);
    chartContainer.appendChild(projectTitle);
    chartContainer.appendChild(viewButton);

    // Append to dashboard container
    dashboardContainer.appendChild(chartContainer);

    // Create chart for the project
    const ctx = document.getElementById(`project${index + 1}Chart`).getContext('2d');
    createCircularChart(ctx, project.progress);

    // Create option in project select dropdown
    const option = document.createElement('option');
    option.value = project.id; // Use project ID as the value
    option.textContent = project.name;
    projectSelect.appendChild(option);
});
        }
    
        // Function to create circular chart
        function createCircularChart(ctx, progress, isSelected = false) {
            const blueColor = isSelected ? '#0056b3' : '#00c0ef';
            const grayColor = isSelected ? '#a9a9a9' : '#d3d3d3';
            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [progress, 100 - progress],
                        backgroundColor: [blueColor, grayColor],
                        borderWidth: 1
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: { enabled: false },
                        legend: { display: false }
                    }
                }
            });
        }
    
        // Fetch project data from API and render projects dynamically
        async function fetchProjectData() {
            try {
                const response = await fetch('http://127.0.0.1:5000/projects');
                const projectData = await response.json();
                console.log('Project Data:', projectData);
    
                projectDataGlobal = projectData; // Store globally
    
                // Dynamically render the projects and charts
                renderProjects(projectData);
    
                // Initial team members rendering for the first project
                if (projectData.length > 0) {
                    renderTeamMembers(projectData[0].id); // Pass the first project ID
                }
            } catch (error) {
                console.error('Error fetching project data:', error);
            }
        }
    
        fetchProjectData(); // Call the function to get project data from the API
    
        // Function to create a progress bar for each team member
        async function renderTeamMembers(projectId) {
            const teamMembersDiv = document.getElementById('teamMembers');
            teamMembersDiv.innerHTML = ''; // Clear previous data
    
            try {
                const response = await fetch(`http://127.0.0.1:5000/projects/${projectId}/team_members`);
                const teamMembers = await response.json();
    
                if (teamMembers.length === 0) {
                    teamMembersDiv.innerHTML = 'No team members for this project.';
                    return;
                }
    
                teamMembers.forEach(member => {
                    const memberContainer = document.createElement('div');
                    memberContainer.classList.add('team-member-container');
    
                    const memberName = document.createElement('div');
                    memberName.classList.add('member-name');
                    memberName.textContent = member.name;
    
                    const progressWrapper = document.createElement('div');
                    progressWrapper.classList.add('progress-wrapper');
    
                    const progressBarWrapper = document.createElement('div');
                    progressBarWrapper.classList.add('progress-bar-wrapper');
    
                    const progressBar = document.createElement('div');
                    progressBar.classList.add('progress-bar');
                    progressBar.style.width = `${member.completed_percentage}%`;
    
                    const issueBar = document.createElement('div');
                    issueBar.classList.add('issue-bar');
                    issueBar.style.width = `${member.blocked_percentage}%`;
    
                    const progressInfo = document.createElement('div');
                    progressInfo.classList.add('progress-info');
                    progressInfo.innerHTML = `<span>Progress: ${member.completed_percentage}%</span><span>Issues: ${member.blocked_percentage}%</span>`;
    
                    progressBarWrapper.appendChild(progressBar);
                    progressBarWrapper.appendChild(issueBar);
                    progressWrapper.appendChild(progressBarWrapper);
                    progressWrapper.appendChild(progressInfo);
    
                    memberContainer.appendChild(memberName);
                    memberContainer.appendChild(progressWrapper);
    
                    teamMembersDiv.appendChild(memberContainer);
                });
            } catch (error) {
                console.error('Error fetching team members:', error);
                teamMembersDiv.innerHTML = 'Failed to load team members.';
            }
        }
    
        // Handle project selection from dropdown
        const projectSelect = document.getElementById('projectSelect');
        projectSelect.addEventListener('change', (event) => {
            const selectedProjectId = event.target.value;
            renderTeamMembers(selectedProjectId);
        });
    </script>
</body>
</html>
{% endblock %}
